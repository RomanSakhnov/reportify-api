# üöÄ Deployment Checklist

Use this checklist for your first deployment to reportify.rs-development.net

## Pre-Deployment

### 1. Install Dependencies

- [ ] Ruby 3.2+ installed (`ruby --version`)
- [ ] Bundler installed (`gem install bundler`)
- [ ] Kamal installed (`gem install kamal`)
- [ ] Git configured

### 2. Server Access

- [ ] Can SSH to server: `ssh -p 2121 rs-dev@rs-development.net`
- [ ] SSH key added to agent: `ssh-add ~/.ssh/your_key`
- [ ] Docker installed on server (verify: `ssh -p 2121 rs-dev@rs-development.net "docker --version"`)

### 3. Configuration Files

- [ ] Created `.env.production` from `.env.production.example`
- [ ] Set `RAILS_MASTER_KEY` in `.env.production`
- [ ] Set `JWT_SECRET_KEY` (long random string)
- [ ] Set `DB_PASSWORD` (secure password)
- [ ] Set Docker registry credentials (if using private registry)
- [ ] Verify `config/deploy.production.yml` exists
- [ ] Verify `Dockerfile` exists
- [ ] Make scripts executable:
  ```bash
  chmod +x bin/deploy.production
  chmod +x bin/docker-entrypoint
  chmod +x bin/check-deployment
  chmod +x .kamal/secrets
  ```

### 4. DNS Configuration

- [ ] Domain `reportify.rs-development.net` points to server IP
- [ ] DNS propagation complete (check: `dig reportify.rs-development.net`)

### 5. Environment Validation

- [ ] All required gems installed: `bundle install`
- [ ] Tests pass: `bundle exec rspec` (optional but recommended)
- [ ] Run pre-deployment check: `bin/check-deployment`

## Initial Deployment

### 6. First-Time Setup

- [ ] Run Kamal setup:
  ```bash
  bin/kamal setup -c config/deploy.production.yml
  ```
  This will:
  - Install Docker (if needed)
  - Create PostgreSQL container (port 5433)
  - Create Redis container (port 6380)

### 7. Deploy Application

- [ ] Deploy with custom script:
  ```bash
  bin/deploy.production
  ```
  Or directly:
  ```bash
  bin/kamal deploy -c config/deploy.production.yml
  ```

### 8. Post-Deployment Verification

- [ ] Check app is running:
  ```bash
  bin/kamal app details -c config/deploy.production.yml
  ```
- [ ] View logs for errors:
  ```bash
  bin/kamal app logs --follow -c config/deploy.production.yml
  ```
- [ ] Test health endpoint:
  ```bash
  curl http://rs-development.net:3002/up
  ```
- [ ] Test API endpoint:
  ```bash
  curl http://rs-development.net:3002/api/v1/items
  ```

## Database Setup

### 9. Database Initialization

- [ ] Check database is running:
  ```bash
  bin/kamal accessory details db -c config/deploy.production.yml
  ```
- [ ] Migrations ran automatically (check logs)
- [ ] If needed, run manually:
  ```bash
  bin/kamal app exec "bin/rails db:migrate" -c config/deploy.production.yml
  ```
- [ ] Seed database (if needed):
  ```bash
  bin/kamal app exec "bin/rails db:seed" -c config/deploy.production.yml
  ```

## Background Jobs

### 10. Sidekiq Verification

- [ ] Check Sidekiq is running:
  ```bash
  bin/kamal accessory details sidekiq -c config/deploy.production.yml
  ```
- [ ] View Sidekiq logs:
  ```bash
  bin/kamal accessory logs sidekiq --follow -c config/deploy.production.yml
  ```
- [ ] Access Sidekiq Web UI (if configured):
  ```
  http://rs-development.net:3002/sidekiq
  ```

## Final Checks

### 11. Full Application Test

- [ ] Can create a user (registration)
- [ ] Can login (authentication)
- [ ] Can access protected endpoints
- [ ] Background jobs are processing
- [ ] Database queries work
- [ ] Redis caching works

### 12. Security Verification

- [ ] HTTPS is working (SSL certificate active)
- [ ] HTTP redirects to HTTPS
- [ ] No sensitive data in logs
- [ ] `.env.production` not in git
- [ ] `config/master.key` not in git
- [ ] `.kamal/secrets` not committed with real values

### 13. Monitoring Setup

- [ ] Know how to check logs: `bin/kamal app logs`
- [ ] Know how to access console: `bin/kamal console`
- [ ] Know how to restart: `bin/kamal app boot`
- [ ] Know how to rollback: `bin/kamal app rollback`

## Regular Deployments

For future deployments, you only need:

```bash
# 1. Check everything is ready
bin/check-deployment

# 2. Deploy
bin/deploy.production

# 3. Verify
bin/kamal app details -c config/deploy.production.yml
```

## Port Reference

Quick reference for your custom ports:

| Service        | URL/Connection                            |
| -------------- | ----------------------------------------- |
| **HTTPS**      | https://reportify.rs-development.net:8443 |
| **HTTP**       | http://reportify.rs-development.net:8080  |
| **PostgreSQL** | localhost:5433 (from server)              |
| **Redis**      | localhost:6380 (from server)              |
| **SSH**        | rs-dev@rs-development.net:2121            |

## Common Issues & Solutions

### Issue: Port already in use

**Solution**: The `bin/deploy.production` script handles this automatically

### Issue: Cannot connect to database

**Solution**: Verify `DB_HOST=localhost` in `.env.production`

### Issue: SSL certificate not working

**Solution**: Ensure DNS is correct and wait a few minutes for Let's Encrypt

### Issue: Assets not loading

**Solution**: Check `RAILS_SERVE_STATIC_FILES=true` is set

### Issue: Sidekiq not processing jobs

**Solution**:

```bash
bin/kamal accessory restart sidekiq -c config/deploy.production.yml
```

## Emergency Procedures

### Rollback to Previous Version

```bash
bin/kamal app rollback -c config/deploy.production.yml
```

### Stop Application

```bash
bin/kamal app stop -c config/deploy.production.yml
```

### Access Rails Console (Debug)

```bash
bin/kamal console -c config/deploy.production.yml
```

### View All Containers

```bash
ssh -p 2121 rs-dev@rs-development.net "docker ps -a"
```

### Manual Database Backup

```bash
bin/kamal accessory exec db "pg_dump -U reportify_user reportify_production" -c config/deploy.production.yml > backup.sql
```

---

## ‚úÖ Deployment Complete!

Once all checkboxes are marked, your API is successfully deployed to:

üåê **http://rs-development.net:3002**

Configure your frontend server to proxy requests to this endpoint.

For detailed information, see:

- [QUICKSTART.md](QUICKSTART.md) - Quick reference
- [DEPLOYMENT.md](DEPLOYMENT.md) - Complete guide
- [KAMAL_SETUP_SUMMARY.md](KAMAL_SETUP_SUMMARY.md) - Configuration summary
