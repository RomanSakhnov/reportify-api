# Kamal Production Deployment Configuration
# Deploy with: kamal deploy -c config/deploy.production.yml
service: reportify-api

# Container image name
image: reportify-api

# Deploy to these servers
servers:
  web:
    hosts:
      - rs-development.net
    options:
      publish:
        - "3002:3000" # Maps host port 3002 to container port 3000
    proxy: false # No proxy - API accessed directly

# Container registry configuration
# localhost:5555 is Kamal's local Docker registry
# Kamal automatically builds locally and creates SSH tunnel for deployment
registry:
  server: localhost:5555

# Environment variables for the application
env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: true
    RAILS_SERVE_STATIC_FILES: true
  secret:
    - RAILS_MASTER_KEY
    - JWT_SECRET_KEY
    - DB_HOST
    - DB_USERNAME
    - DB_PASSWORD
    - REDIS_URL

# SSH configuration
ssh:
  user: rs-dev
  port: 2121

# Builder configuration
builder:
  arch: amd64

# Volume mounts for persistent data
volumes:
  - "reportify_storage:/rails/storage"

# Accessories (PostgreSQL, Redis, Sidekiq)
accessories:
  db:
    image: postgres:15
    host: rs-development.net
    env:
      clear:
        POSTGRES_DB: reportify_production
        POSTGRES_HOST_AUTH_METHOD: trust
    directories:
      - reportify_db_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    host: rs-development.net
    directories:
      - reportify_redis_data:/data

  sidekiq:
    image: reportify-api
    host: rs-development.net
    cmd: bundle exec sidekiq -C config/sidekiq.yml
    env:
      clear:
        RAILS_ENV: production
      secret:
        - RAILS_MASTER_KEY
        - JWT_SECRET_KEY
        - DB_HOST
        - DB_USERNAME
        - DB_PASSWORD
        - REDIS_URL

# Aliases for common commands
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs --follow
  dbc: app exec --interactive --reuse "bin/rails dbconsole"
