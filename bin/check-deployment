#!/usr/bin/env bash
set -e

echo "ðŸ” Checking deployment prerequisites..."
echo ""

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if all checks pass
ALL_GOOD=true

# Check 1: Kamal installed
echo -n "Checking Kamal installation... "
if command -v kamal &> /dev/null; then
    echo -e "${GREEN}âœ“${NC} Kamal found ($(kamal version))"
else
    echo -e "${RED}âœ—${NC} Kamal not found"
    echo "   Install with: gem install kamal"
    ALL_GOOD=false
fi

# Check 2: SSH connectivity
echo -n "Checking SSH connection to rs-development.net... "
if ssh -p 2121 -o ConnectTimeout=5 -o BatchMode=yes rs-dev@rs-development.net "echo 'connected'" &> /dev/null; then
    echo -e "${GREEN}âœ“${NC} SSH connection successful"
else
    echo -e "${RED}âœ—${NC} Cannot connect via SSH"
    echo "   Check: ssh -p 2121 rs-dev@rs-development.net"
    echo "   Make sure your SSH key is added: ssh-add ~/.ssh/your_key"
    ALL_GOOD=false
fi

# Check 3: Docker on server
echo -n "Checking Docker on server... "
if ssh -p 2121 rs-dev@rs-development.net "docker --version" &> /dev/null; then
    DOCKER_VERSION=$(ssh -p 2121 rs-dev@rs-development.net "docker --version" 2>/dev/null | cut -d' ' -f3 | cut -d',' -f1)
    echo -e "${GREEN}âœ“${NC} Docker found (${DOCKER_VERSION})"
else
    echo -e "${RED}âœ—${NC} Docker not found on server"
    echo "   Install Docker on the server first"
    ALL_GOOD=false
fi

# Check 4: .env.production file
echo -n "Checking .env.production file... "
if [ -f ".env.production" ]; then
    echo -e "${GREEN}âœ“${NC} Found"
    
    # Check for required variables
    REQUIRED_VARS=("RAILS_MASTER_KEY" "JWT_SECRET_KEY" "DB_PASSWORD")
    for var in "${REQUIRED_VARS[@]}"; do
        if grep -q "^${var}=" .env.production && ! grep -q "^${var}=your-" .env.production; then
            echo -e "   ${GREEN}âœ“${NC} ${var} is set"
        else
            echo -e "   ${RED}âœ—${NC} ${var} is missing or not configured"
            ALL_GOOD=false
        fi
    done
else
    echo -e "${RED}âœ—${NC} Not found"
    echo "   Copy .env.production.example to .env.production and fill in values"
    ALL_GOOD=false
fi

# Check 5: Rails master key
echo -n "Checking Rails master key... "
if [ -f "config/master.key" ]; then
    echo -e "${GREEN}âœ“${NC} config/master.key exists"
elif [ ! -z "${RAILS_MASTER_KEY}" ]; then
    echo -e "${GREEN}âœ“${NC} RAILS_MASTER_KEY environment variable set"
elif [ -f ".env.production" ] && grep -q "^RAILS_MASTER_KEY=" .env.production; then
    echo -e "${GREEN}âœ“${NC} RAILS_MASTER_KEY in .env.production"
else
    echo -e "${RED}âœ—${NC} No master key found"
    echo "   Either create config/master.key or set RAILS_MASTER_KEY"
    ALL_GOOD=false
fi

# Check 6: Deployment configuration
echo -n "Checking Kamal deployment config... "
if [ -f "config/deploy.yml" ]; then
    echo -e "${GREEN}âœ“${NC} config/deploy.yml exists"
else
    echo -e "${RED}âœ—${NC} config/deploy.yml not found"
    ALL_GOOD=false
fi

# Check 7: Dockerfile
echo -n "Checking Dockerfile... "
if [ -f "Dockerfile" ]; then
    echo -e "${GREEN}âœ“${NC} Dockerfile exists"
else
    echo -e "${RED}âœ—${NC} Dockerfile not found"
    ALL_GOOD=false
fi

# Check 8: Port availability on server
echo -n "Checking port availability on server... "
PORTS_IN_USE=$(ssh -p 2121 rs-dev@rs-development.net "netstat -tuln 2>/dev/null | grep -E ':(3002|8080|8443|5433|6380)' || true")
if [ -z "$PORTS_IN_USE" ]; then
    echo -e "${GREEN}âœ“${NC} Required ports are available"
else
    echo -e "${YELLOW}âš ${NC} Some ports may be in use:"
    echo "$PORTS_IN_USE" | sed 's/^/   /'
    echo "   The deployment script will attempt to clean up old containers"
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ "$ALL_GOOD" = true ]; then
    echo -e "${GREEN}âœ“ All checks passed! Ready to deploy.${NC}"
    echo ""
    echo "Run deployment with:"
    echo "  bin/deploy"
    exit 0
else
    echo -e "${RED}âœ— Some checks failed. Please fix the issues above.${NC}"
    exit 1
fi
