# Kamal Quick Command Reference

Quick reference for common Kamal commands with your production configuration.

## üöÄ Deployment Commands

```bash
# Check prerequisites
bin/check-deployment

# Initial setup (first time only)
bin/kamal setup -c config/deploy.production.yml

# Deploy application (with auto-cleanup)
bin/deploy.production

# Deploy directly with Kamal
bin/kamal deploy -c config/deploy.production.yml

# Rollback to previous version
bin/kamal app rollback -c config/deploy.production.yml
```

## üìä Monitoring & Logs

```bash
# View application logs (follow mode)
bin/kamal app logs --follow -c config/deploy.production.yml

# View last 100 lines
bin/kamal app logs --lines 100 -c config/deploy.production.yml

# View Sidekiq logs
bin/kamal accessory logs sidekiq --follow -c config/deploy.production.yml

# View PostgreSQL logs
bin/kamal accessory logs db -c config/deploy.production.yml

# View Redis logs
bin/kamal accessory logs redis -c config/deploy.production.yml

# Check application status
bin/kamal app details -c config/deploy.production.yml

# Check all accessories status
bin/kamal accessory details -c config/deploy.production.yml
```

## üîß Application Control

```bash
# Start/boot application
bin/kamal app boot -c config/deploy.production.yml

# Stop application
bin/kamal app stop -c config/deploy.production.yml

# Restart application
bin/kamal app stop -c config/deploy.production.yml && \
bin/kamal app boot -c config/deploy.production.yml

# Remove application
bin/kamal app remove -c config/deploy.production.yml
```

## üíª Interactive Sessions

```bash
# Rails console
bin/kamal app exec --interactive --reuse "bin/rails console" -c config/deploy.production.yml
# Or using alias:
bin/kamal console -c config/deploy.production.yml

# Bash shell in container
bin/kamal app exec --interactive --reuse "bash" -c config/deploy.production.yml
# Or using alias:
bin/kamal shell -c config/deploy.production.yml

# Database console
bin/kamal app exec --interactive --reuse "bin/rails dbconsole" -c config/deploy.production.yml
# Or using alias:
bin/kamal dbc -c config/deploy.production.yml
```

## üóÑÔ∏è Database Operations

```bash
# Run migrations
bin/kamal app exec "bin/rails db:migrate" -c config/deploy.production.yml

# Rollback last migration
bin/kamal app exec "bin/rails db:rollback" -c config/deploy.production.yml

# Seed database
bin/kamal app exec "bin/rails db:seed" -c config/deploy.production.yml

# Reset database (DANGER!)
bin/kamal app exec "bin/rails db:reset" -c config/deploy.production.yml

# Check migration status
bin/kamal app exec "bin/rails db:migrate:status" -c config/deploy.production.yml
```

## üîÑ Accessories Management

```bash
# Start/restart accessories
bin/kamal accessory boot db -c config/deploy.production.yml
bin/kamal accessory boot redis -c config/deploy.production.yml
bin/kamal accessory boot sidekiq -c config/deploy.production.yml

# Restart specific accessory
bin/kamal accessory restart db -c config/deploy.production.yml
bin/kamal accessory restart redis -c config/deploy.production.yml
bin/kamal accessory restart sidekiq -c config/deploy.production.yml

# Stop accessories
bin/kamal accessory stop db -c config/deploy.production.yml
bin/kamal accessory stop redis -c config/deploy.production.yml
bin/kamal accessory stop sidekiq -c config/deploy.production.yml

# Remove accessories
bin/kamal accessory remove db -c config/deploy.production.yml
bin/kamal accessory remove redis -c config/deploy.production.yml
bin/kamal accessory remove sidekiq -c config/deploy.production.yml
```

## üåê Network Access

**Note**: This API doesn't use a proxy (Traefik). It's accessed directly via port 3002.

Your frontend server should proxy requests to: `http://rs-development.net:3002`

## üèóÔ∏è Build & Registry

```bash
# Build Docker image
bin/kamal build -c config/deploy.production.yml

# Push image to registry
bin/kamal push -c config/deploy.production.yml

# Pull image from registry
bin/kamal pull -c config/deploy.production.yml

# Remove image
bin/kamal remove -c config/deploy.production.yml
```

## üîê Environment & Secrets

```bash
# Print environment variables
bin/kamal app exec "env" -c config/deploy.production.yml

# Check specific variable
bin/kamal app exec "env | grep RAILS_ENV" -c config/deploy.production.yml

# View secrets (from local machine)
cat .kamal/secrets
```

## üì¶ Docker Operations

```bash
# List all containers on server
bin/kamal app exec "docker ps -a" -c config/deploy.production.yml

# Check disk usage
ssh -p 2121 rs-dev@rs-development.net "docker system df"

# Clean up unused containers/images
ssh -p 2121 rs-dev@rs-development.net "docker system prune -a"

# View Docker volumes
ssh -p 2121 rs-dev@rs-development.net "docker volume ls"
```

## üßπ Cleanup Operations

```bash
# Remove old containers (keeps last 5)
bin/kamal prune -c config/deploy.production.yml

# Remove unused Docker resources
ssh -p 2121 rs-dev@rs-development.net "docker system prune -f"

# Remove unused images
ssh -p 2121 rs-dev@rs-development.net "docker image prune -a -f"
```

## üîç Debugging

```bash
# Check what's listening on ports
ssh -p 2121 rs-dev@rs-development.net "netstat -tuln | grep -E ':(3002|8080|8443|5433|6380)'"

# Check container health
bin/kamal app exec "curl http://localhost:3000/up" -c config/deploy.production.yml

# View container inspect
ssh -p 2121 rs-dev@rs-development.net "docker inspect <container_id>"

# Check container resource usage
ssh -p 2121 rs-dev@rs-development.net "docker stats"

# View container logs directly
ssh -p 2121 rs-dev@rs-development.net "docker logs <container_id>"
```

## üÜò Emergency Commands

```bash
# Rollback immediately
bin/kamal app rollback -c config/deploy.production.yml

# Stop everything
bin/kamal app stop -c config/deploy.production.yml
bin/kamal accessory stop all -c config/deploy.production.yml
bin/kamal proxy stop -c config/deploy.production.yml

# Force remove stuck container
ssh -p 2121 rs-dev@rs-development.net "docker rm -f <container_id>"

# Restart Docker daemon
ssh -p 2121 rs-dev@rs-development.net "sudo systemctl restart docker"
```

## üìù Configuration

```bash
# View current configuration
cat config/deploy.production.yml

# Validate configuration
bin/kamal config -c config/deploy.production.yml

# Check what will be deployed
bin/kamal config -c config/deploy.production.yml | grep image
```

## üîó Connection Info

```bash
# SSH to server
ssh -p 2121 rs-dev@rs-development.net

# Test application endpoints (direct API access)
curl http://rs-development.net:3002/up
curl http://rs-development.net:3002/health
curl http://rs-development.net:3002/api/v1/items

# Connect to PostgreSQL (from server)
ssh -p 2121 rs-dev@rs-development.net
docker exec -it <postgres_container_id> psql -U reportify_user -d reportify_production

# Connect to Redis (from server)
ssh -p 2121 rs-dev@rs-development.net
docker exec -it <redis_container_id> redis-cli
```

## üí° Tips

1. **Save typing** - Create aliases in your shell:

   ```bash
   alias kdeploy='bin/deploy.production'
   alias klogs='bin/kamal app logs --follow -c config/deploy.production.yml'
   alias kconsole='bin/kamal console -c config/deploy.production.yml'
   alias kshell='bin/kamal shell -c config/deploy.production.yml'
   ```

2. **Quick checks** after deployment:

   ```bash
   bin/kamal app details && curl https://reportify.rs-development.net:8443/up
   ```

3. **Watch logs during deployment**:

   ```bash
   # In another terminal
   bin/kamal app logs --follow -c config/deploy.production.yml
   ```

4. **Backup before risky operations**:
   ```bash
   bin/kamal accessory exec db "pg_dump -U reportify_user reportify_production" \
     -c config/deploy.production.yml > backup-$(date +%Y%m%d).sql
   ```

---

## üîó Quick Access

- **API**: http://rs-development.net:3002
- **Health Check**: http://rs-development.net:3002/up
- **Sidekiq UI**: http://rs-development.net:3002/sidekiq

**Server Access**: `ssh -p 2121 rs-dev@rs-development.net`

**Note**: Your frontend server should handle HTTPS and proxy to this API endpoint.

**Documentation**:

- [QUICKSTART.md](QUICKSTART.md) - Getting started
- [DEPLOYMENT.md](DEPLOYMENT.md) - Full guide
- [.deployment-checklist.md](.deployment-checklist.md) - Step-by-step checklist
